# LinkFlow AI - Istio Authorization Policies
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: linkflow
spec:
  {}  # Deny all by default
---
# Allow ingress gateway
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-ingress
  namespace: linkflow
spec:
  selector:
    matchLabels:
      app: gateway-service
  action: ALLOW
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
---
# Allow internal service communication
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-internal
  namespace: linkflow
spec:
  action: ALLOW
  rules:
    - from:
        - source:
            namespaces: ["linkflow"]
---
# Auth service - public endpoints
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: auth-service-public
  namespace: linkflow
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
    - to:
        - operation:
            paths: ["/api/v1/auth/login", "/api/v1/auth/register", "/api/v1/auth/refresh", "/health*"]
            methods: ["POST", "GET"]
---
# Webhook service - external access
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: webhook-service-external
  namespace: linkflow
spec:
  selector:
    matchLabels:
      app: webhook-service
  action: ALLOW
  rules:
    - to:
        - operation:
            paths: ["/api/v1/webhooks/incoming/*"]
            methods: ["POST"]
---
# Rate limiting
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: rate-limit-auth
  namespace: linkflow
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
    - when:
        - key: request.headers[x-rate-limit-remaining]
          notValues: ["0"]
---
# PeerAuthentication - strict mTLS
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: linkflow
spec:
  mtls:
    mode: STRICT
---
# RequestAuthentication for JWT
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: linkflow
spec:
  selector:
    matchLabels:
      istio: ingressgateway
  jwtRules:
    - issuer: "https://auth.linkflow.ai"
      jwksUri: "https://auth.linkflow.ai/.well-known/jwks.json"
      audiences:
        - "linkflow-api"
      forwardOriginalToken: true
---
# Service Entries for external services
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-apis
  namespace: linkflow
spec:
  hosts:
    - "api.github.com"
    - "api.slack.com"
    - "www.googleapis.com"
    - "api.dropbox.com"
    - "api.atlassian.com"
  ports:
    - number: 443
      name: https
      protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
---
# Egress traffic policy
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: external-apis-tls
  namespace: linkflow
spec:
  host: "*.googleapis.com"
  trafficPolicy:
    tls:
      mode: SIMPLE
