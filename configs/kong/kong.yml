# =============================================================================
# LinkFlow AI - Kong API Gateway Configuration
# =============================================================================
# Single config file for all environments
# Rate limits are set for production, relaxed by high values for dev testing
# =============================================================================

_format_version: "3.0"
_transform: true

# =============================================================================
# SERVICES & ROUTES
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # AUTH SERVICE (Public - No JWT required for login/register)
  # ---------------------------------------------------------------------------
  - name: auth-service
    url: http://auth:8001
    routes:
      - name: auth-routes
        paths:
          - /api/v1/auth
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # ---------------------------------------------------------------------------
  # USER SERVICE
  # ---------------------------------------------------------------------------
  - name: user-service
    url: http://user:8002
    routes:
      - name: user-routes
        paths:
          - /api/v1/users
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          policy: local

  # ---------------------------------------------------------------------------
  # WORKFLOW SERVICE
  # ---------------------------------------------------------------------------
  - name: workflow-service
    url: http://workflow:8004
    routes:
      - name: workflow-routes
        paths:
          - /api/v1/workflows
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          policy: local

  # ---------------------------------------------------------------------------
  # EXECUTION SERVICE
  # ---------------------------------------------------------------------------
  - name: execution-service
    url: http://execution:8003
    routes:
      - name: execution-routes
        paths:
          - /api/v1/executions
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 1000
          policy: local

  # ---------------------------------------------------------------------------
  # NODE SERVICE
  # ---------------------------------------------------------------------------
  - name: node-service
    url: http://node:8005
    routes:
      - name: node-routes
        paths:
          - /api/v1/nodes
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          policy: local

  # ---------------------------------------------------------------------------
  # EXECUTOR SERVICE
  # ---------------------------------------------------------------------------
  - name: executor-service
    url: http://executor:8007
    routes:
      - name: executor-routes
        paths:
          - /api/v1/executor
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 1000
          policy: local

  # ---------------------------------------------------------------------------
  # WEBHOOK SERVICE
  # ---------------------------------------------------------------------------
  - name: webhook-service
    url: http://webhook:8008
    routes:
      - name: webhook-routes
        paths:
          - /api/v1/webhooks
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 10

  # ---------------------------------------------------------------------------
  # SCHEDULE SERVICE
  # ---------------------------------------------------------------------------
  - name: schedule-service
    url: http://schedule:8009
    routes:
      - name: schedule-routes
        paths:
          - /api/v1/schedules
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          policy: local

  # ---------------------------------------------------------------------------
  # CREDENTIAL SERVICE
  # ---------------------------------------------------------------------------
  - name: credential-service
    url: http://credential:8010
    routes:
      - name: credential-routes
        paths:
          - /api/v1/credentials
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # ---------------------------------------------------------------------------
  # NOTIFICATION SERVICE
  # ---------------------------------------------------------------------------
  - name: notification-service
    url: http://notification:8011
    routes:
      - name: notification-routes
        paths:
          - /api/v1/notifications
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          policy: local

  # ---------------------------------------------------------------------------
  # INTEGRATION SERVICE
  # ---------------------------------------------------------------------------
  - name: integration-service
    url: http://integration:8012
    routes:
      - name: integration-routes
        paths:
          - /api/v1/integrations
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          policy: local

  # ---------------------------------------------------------------------------
  # ANALYTICS SERVICE
  # ---------------------------------------------------------------------------
  - name: analytics-service
    url: http://analytics:8013
    routes:
      - name: analytics-routes
        paths:
          - /api/v1/analytics
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 300
          policy: local

  # ---------------------------------------------------------------------------
  # SEARCH SERVICE
  # ---------------------------------------------------------------------------
  - name: search-service
    url: http://search:8014
    routes:
      - name: search-routes
        paths:
          - /api/v1/search
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 300
          policy: local

  # ---------------------------------------------------------------------------
  # STORAGE SERVICE
  # ---------------------------------------------------------------------------
  - name: storage-service
    url: http://storage:8015
    routes:
      - name: storage-routes
        paths:
          - /api/v1/storage
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 100

  # ---------------------------------------------------------------------------
  # CONFIG SERVICE
  # ---------------------------------------------------------------------------
  - name: config-service
    url: http://config:8016
    routes:
      - name: config-routes
        paths:
          - /api/v1/config
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # ---------------------------------------------------------------------------
  # ADMIN SERVICE
  # ---------------------------------------------------------------------------
  - name: admin-service
    url: http://admin:8017
    routes:
      - name: admin-routes
        paths:
          - /api/v1/admin
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # ---------------------------------------------------------------------------
  # TENANT SERVICE (port 8019)
  # ---------------------------------------------------------------------------
  - name: tenant-service
    url: http://tenant:8019
    routes:
      - name: tenant-routes
        paths:
          - /api/v1/tenants
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # ---------------------------------------------------------------------------
  # MONITORING SERVICE (port 8020)
  # ---------------------------------------------------------------------------
  - name: monitoring-service
    url: http://monitoring:8020
    routes:
      - name: monitoring-routes
        paths:
          - /api/v1/monitoring
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local

  # ---------------------------------------------------------------------------
  # BACKUP SERVICE (port 8021)
  # ---------------------------------------------------------------------------
  - name: backup-service
    url: http://backup:8021
    routes:
      - name: backup-routes
        paths:
          - /api/v1/backup
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 50
          policy: local

  # ---------------------------------------------------------------------------
  # MIGRATION SERVICE (port 8022)
  # ---------------------------------------------------------------------------
  - name: migration-service
    url: http://migration:8022
    routes:
      - name: migration-routes
        paths:
          - /api/v1/migration
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 50
          policy: local

  # ---------------------------------------------------------------------------
  # HEALTH CHECKS (Public - No auth, No rate limit)
  # Real-world health endpoints for Kubernetes/Docker healthchecks
  # ---------------------------------------------------------------------------
  
  # Aggregated health check endpoint (checks all services)
  - name: health-aggregated
    url: http://gateway:8000/health/ready
    routes:
      - name: health-aggregated-route
        paths:
          - /health
        strip_path: true

  # Individual service health checks - live (is it running?)
  - name: health-auth-live
    url: http://auth:8001/health/live
    routes:
      - name: health-auth-live-route
        paths:
          - /health/auth/live
        strip_path: true

  - name: health-user-live
    url: http://user:8002/health/live
    routes:
      - name: health-user-live-route
        paths:
          - /health/user/live
        strip_path: true

  - name: health-workflow-live
    url: http://workflow:8004/health/live
    routes:
      - name: health-workflow-live-route
        paths:
          - /health/workflow/live
        strip_path: true

  - name: health-execution-live
    url: http://execution:8003/health/live
    routes:
      - name: health-execution-live-route
        paths:
          - /health/execution/live
        strip_path: true

  - name: health-node-live
    url: http://node:8005/health/live
    routes:
      - name: health-node-live-route
        paths:
          - /health/node/live
        strip_path: true

  - name: health-executor-live
    url: http://executor:8007/health/live
    routes:
      - name: health-executor-live-route
        paths:
          - /health/executor/live
        strip_path: true

  - name: health-webhook-live
    url: http://webhook:8008/health/live
    routes:
      - name: health-webhook-live-route
        paths:
          - /health/webhook/live
        strip_path: true

  - name: health-schedule-live
    url: http://schedule:8009/health/live
    routes:
      - name: health-schedule-live-route
        paths:
          - /health/schedule/live
        strip_path: true

  - name: health-credential-live
    url: http://credential:8010/health/live
    routes:
      - name: health-credential-live-route
        paths:
          - /health/credential/live
        strip_path: true

  - name: health-notification-live
    url: http://notification:8011/health/live
    routes:
      - name: health-notification-live-route
        paths:
          - /health/notification/live
        strip_path: true

  - name: health-integration-live
    url: http://integration:8012/health/live
    routes:
      - name: health-integration-live-route
        paths:
          - /health/integration/live
        strip_path: true

  - name: health-analytics-live
    url: http://analytics:8013/health/live
    routes:
      - name: health-analytics-live-route
        paths:
          - /health/analytics/live
        strip_path: true

  - name: health-search-live
    url: http://search:8014/health/live
    routes:
      - name: health-search-live-route
        paths:
          - /health/search/live
        strip_path: true

  - name: health-storage-live
    url: http://storage:8015/health/live
    routes:
      - name: health-storage-live-route
        paths:
          - /health/storage/live
        strip_path: true

  - name: health-config-live
    url: http://config:8016/health/live
    routes:
      - name: health-config-live-route
        paths:
          - /health/config/live
        strip_path: true

  - name: health-admin-live
    url: http://admin:8017/health/live
    routes:
      - name: health-admin-live-route
        paths:
          - /health/admin/live
        strip_path: true

  - name: health-tenant-live
    url: http://tenant:8019/health/live
    routes:
      - name: health-tenant-live-route
        paths:
          - /health/tenant/live
        strip_path: true

  - name: health-monitoring-live
    url: http://monitoring:8020/health/live
    routes:
      - name: health-monitoring-live-route
        paths:
          - /health/monitoring/live
        strip_path: true

  - name: health-backup-live
    url: http://backup:8021/health/live
    routes:
      - name: health-backup-live-route
        paths:
          - /health/backup/live
        strip_path: true

  - name: health-migration-live
    url: http://migration:8022/health/live
    routes:
      - name: health-migration-live-route
        paths:
          - /health/migration/live
        strip_path: true

  # Individual service health checks - ready (can it accept traffic?)
  - name: health-auth-ready
    url: http://auth:8001/health/ready
    routes:
      - name: health-auth-ready-route
        paths:
          - /health/auth/ready
        strip_path: true

  - name: health-user-ready
    url: http://user:8002/health/ready
    routes:
      - name: health-user-ready-route
        paths:
          - /health/user/ready
        strip_path: true

  - name: health-workflow-ready
    url: http://workflow:8004/health/ready
    routes:
      - name: health-workflow-ready-route
        paths:
          - /health/workflow/ready
        strip_path: true

  - name: health-execution-ready
    url: http://execution:8003/health/ready
    routes:
      - name: health-execution-ready-route
        paths:
          - /health/execution/ready
        strip_path: true

# =============================================================================
# GLOBAL PLUGINS
# =============================================================================

plugins:
  # CORS - Allow all origins (restrict in production via ALLOWED_ORIGINS env)
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Request-ID
        - X-Correlation-ID
      exposed_headers:
        - X-Request-ID
        - X-Correlation-ID
      credentials: true
      max_age: 3600

  # Add gateway version header
  - name: request-transformer
    config:
      add:
        headers:
          - X-Gateway-Version:1.0.0
